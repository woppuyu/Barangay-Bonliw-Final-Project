<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Barangay Bonliw Appointment System</title>
  <link rel="stylesheet" href="/css/style.css">
  <script src="/js/toast.js"></script>
  <script src="/js/password-toggle.js"></script>
</head>
<body>
  <div class="hero">
    <div class="container">
      <h1>Barangay Bonliw Appointment System</h1>
      <p>Skip the long lines and multiple trips to the barangay hall. Book your appointment online, check required documents beforehand, and simply arrive at your scheduled time. Fast, easy, and convenient for both residents and barangay officials.</p>
      <div style="display: flex; gap: 12px; justify-content: center; margin-top: 32px;">
        <button class="btn btn-primary" id="openAuthModal">Get Started</button>
      </div>
    </div>
  </div>

  <!-- Combined Login/Register Modal -->
  <div class="modal-overlay" id="authModal" aria-hidden="true">
    <div class="modal-content centered" style="max-width: 480px; width: 100%;">
      <div class="modal-header" style="text-align: center;">
        <h3 style="width:100%;" id="authModalTitle">Login</h3>
      </div>
      <div class="modal-body">
        <div id="message"></div>
        
        <!-- Login Form -->
        <form id="loginForm" style="display: block;">
          <div class="form-group">
            <label for="login_username">Username</label>
            <input type="text" id="login_username" name="username" required autocomplete="username">
          </div>
          <div class="form-group">
            <label for="login_password">Password</label>
            <div class="password-field">
              <input type="password" id="login_password" name="password" required autocomplete="current-password">
              <button type="button" class="toggle-password" aria-label="Show password" data-target="login_password"></button>
            </div>
          </div>
          <div class="modal-footer" style="justify-content: center;">
            <button type="button" class="btn-secondary" id="cancelAuth">Cancel</button>
            <button type="submit" class="btn btn-primary">Login</button>
          </div>
          <div class="auth-footer" style="margin-top: 16px;">
            Don't have an account? <a href="#" id="switchToRegister">Create one</a>
          </div>
        </form>

        <!-- Register (two-step, no slide) -->
        <div id="registerViewport" style="display:none;">
          <div id="registerSteps" style="display:block;">
            <!-- Step 1: Details -->
            <form id="registerForm" style="flex: 0 0 50%; padding-right: 8px;" novalidate>
              <div class="form-group">
                <label for="reg_username">Username *</label>
                <input type="text" id="reg_username" name="username" required autocomplete="username">
                <div class="field-error" id="error_reg_username"></div>
              </div>
              <div class="form-group">
                <label for="reg_password">Password *</label>
                <div class="password-field">
                  <input type="password" id="reg_password" name="password" required autocomplete="new-password">
                  <button type="button" class="toggle-password" aria-label="Show password" data-target="reg_password"></button>
                </div>
                <div class="field-error" id="error_reg_password"></div>
              </div>
              <div class="form-group">
                <label for="reg_first_name">First Name *</label>
                <input type="text" id="reg_first_name" name="first_name" required autocomplete="given-name">
                <div class="field-error" id="error_reg_first_name"></div>
              </div>
              <div class="form-group">
                <label for="reg_last_name">Last Name *</label>
                <input type="text" id="reg_last_name" name="last_name" required autocomplete="family-name">
                <div class="field-error" id="error_reg_last_name"></div>
              </div>
              <div class="form-group">
                <label for="reg_middle_name">Middle Name</label>
                <input type="text" id="reg_middle_name" name="middle_name" autocomplete="additional-name">
              </div>
              <div class="form-group">
                <label for="reg_contact">Email/Phone Number</label>
                <input type="text" id="reg_contact" name="contact">
                <div class="field-error" id="error_reg_contact"></div>
              </div>
              <div class="form-group">
                <label for="reg_address">Address</label>
                <textarea id="reg_address" name="address" rows="3"></textarea>
              </div>
              <div class="modal-footer" style="justify-content: center;">
                <button type="button" class="btn-secondary" id="cancelRegister">Cancel</button>
                <button type="submit" class="btn btn-primary">Continue</button>
              </div>
              <div class="auth-footer" style="margin-top: 16px;">
                Already have an account? <a href="#" id="switchToLogin">Login here</a>
              </div>
            </form>

            <!-- Step 2: Email Verification -->
            <form id="registerVerifyForm" style="padding-left: 8px; display: none;">
              <p id="verifyHelp" style="margin-bottom: 16px; color:#4a5568; font-size: 14px;">Enter the 6-digit code sent to your email.</p>
              <div class="form-group">
                <label for="reg_verification_code">Verification Code</label>
                <input type="text" id="reg_verification_code" maxlength="6" placeholder="123456" required>
                <div class="field-error" id="error_reg_code"></div>
              </div>
              <div class="modal-footer" style="justify-content: center;">
                <div style="display:flex; gap: 8px; width: 100%;">
                  <button type="button" class="btn-secondary" id="backToRegister" style="flex:1;">Back</button>
                  <button type="button" class="btn btn-secondary" id="resendCodeBtn" style="flex:1;">Resend Code</button>
                  <button type="submit" class="btn btn-primary" style="flex:1;">Verify</button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const modal = document.getElementById('authModal');
      const openBtn = document.getElementById('openAuthModal');
      const cancelAuthBtn = document.getElementById('cancelAuth');
      const cancelRegisterBtn = document.getElementById('cancelRegister');
      const switchToRegisterBtn = document.getElementById('switchToRegister');
      const switchToLoginBtn = document.getElementById('switchToLogin');
      const loginForm = document.getElementById('loginForm');
      const registerViewport = document.getElementById('registerViewport');
      const registerSteps = document.getElementById('registerSteps');
      const registerForm = document.getElementById('registerForm');
      const registerVerifyForm = document.getElementById('registerVerifyForm');
      const verifyHelp = document.getElementById('verifyHelp');
      const resendCodeBtn = document.getElementById('resendCodeBtn');
      const modalTitle = document.getElementById('authModalTitle');
      const messageDiv = document.getElementById('message');
      let regToken = null;
      let pendingLogin = null;
      let resendTimerId = null;
      let resendRemaining = 0;
      // Dynamic label update for contact field
      const regContactInput = document.getElementById('reg_contact');
      const regContactLabel = document.querySelector('label[for="reg_contact"]');
      function updateContactLabel() {
        if (!regContactInput || !regContactLabel) return;
        const v = regContactInput.value.trim();
        // Early intent detection: switch label as user types
        const looksLikePhone = v.startsWith('09') || v.startsWith('+63');
        const looksLikeEmail = /[A-Za-z@]/.test(v);
        if (!v) {
          regContactLabel.textContent = 'Email/Phone Number';
        } else if (looksLikePhone) {
          regContactLabel.textContent = 'Phone Number (+63 or 09)';
        } else if (looksLikeEmail) {
          regContactLabel.textContent = 'Email';
        } else {
          regContactLabel.textContent = 'Email/Phone Number';
        }
      }
      if (regContactInput) {
        regContactInput.addEventListener('input', updateContactLabel);
        updateContactLabel();
      }
      let currentMode = 'login';

      function clearForms() {
        if (loginForm) loginForm.reset();
        if (registerForm) registerForm.reset();
        if (messageDiv) messageDiv.innerHTML = '';
        clearRegisterErrors();
      }

      function showLogin() {
        currentMode = 'login';
        loginForm.style.display = 'block';
        registerViewport.style.display = 'none';
        modalTitle.textContent = 'Login';
        messageDiv.innerHTML = '';
        localStorage.setItem('lastAuthMode', 'login');
      }

      function showRegister() {
        currentMode = 'register';
        loginForm.style.display = 'none';
        registerViewport.style.display = 'block';
        registerForm.style.display = 'block';
        if (registerVerifyForm) registerVerifyForm.style.display = 'none';
        modalTitle.textContent = 'Register Account';
        messageDiv.innerHTML = '';
        clearRegisterErrors();
        localStorage.setItem('lastAuthMode', 'register');
      }

      function openModal(mode = 'login') {
        const lastMode = localStorage.getItem('lastAuthMode') || mode;
        if (lastMode === 'register') {
          showRegister();
        } else {
          showLogin();
        }
        modal.classList.add('active');
        document.body.classList.add('modal-open');
      }

      function closeModal() {
        modal.classList.remove('active');
        setTimeout(() => {
          document.body.classList.remove('modal-open');
        }, 300);
      }

      function setResendButtonState({ disabled, seconds }) {
        if (!resendCodeBtn) return;
        resendCodeBtn.disabled = !!disabled;
        if (disabled && typeof seconds === 'number') {
          resendCodeBtn.innerHTML = `Resend Code<span class="btn-subtext">(${seconds}s)</span>`;
        } else {
          resendCodeBtn.innerHTML = 'Resend Code';
        }
      }

      function clearResendCountdown() {
        if (resendTimerId) {
          clearInterval(resendTimerId);
          resendTimerId = null;
        }
        resendRemaining = 0;
        setResendButtonState({ disabled: false });
      }

      function startResendCountdown(seconds = 60) {
        clearResendCountdown();
        resendRemaining = seconds;
        setResendButtonState({ disabled: true, seconds: resendRemaining });
        resendTimerId = setInterval(() => {
          resendRemaining -= 1;
          if (resendRemaining <= 0) {
            clearResendCountdown();
          } else {
            setResendButtonState({ disabled: true, seconds: resendRemaining });
          }
        }, 1000);
      }

      if (openBtn) openBtn.addEventListener('click', () => openModal());
      
      // Clear forms when explicitly cancelling
      if (cancelAuthBtn) cancelAuthBtn.addEventListener('click', () => { 
        clearForms(); 
        closeModal(); 
      });
      if (cancelRegisterBtn) cancelRegisterBtn.addEventListener('click', () => { 
        clearForms(); 
        closeModal(); 
      });
      
      // Don't clear forms when switching between login/register
      if (switchToRegisterBtn) switchToRegisterBtn.addEventListener('click', (e) => { 
        e.preventDefault(); 
        showRegister(); 
      });
      if (switchToLoginBtn) switchToLoginBtn.addEventListener('click', (e) => { 
        e.preventDefault(); 
        showLogin(); 
      });

      // Close on overlay click (clear forms)
      modal.addEventListener('click', (e) => { 
        if (e.target === modal) {
          clearForms();
          clearResendCountdown();
          closeModal();
        }
      });

      // Close on ESC key (clear forms)
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.classList.contains('active')) {
          clearForms();
          clearResendCountdown();
          closeModal();
        }
      });

      // Handle login form submission
      loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        messageDiv.innerHTML = '';

        const formData = {
          username: document.getElementById('login_username').value.trim(),
          password: document.getElementById('login_password').value
        };

        try {
          const response = await fetch('/api/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
          });

          const data = await response.json();

          if (response.ok) {
            localStorage.setItem('token', data.token);
            localStorage.setItem('user', JSON.stringify(data.user));
            
            // Redirect based on role and approval status
            if (data.user.role === 'admin') {
              window.location.href = '/admin';
            } else if (data.user.approved) {
              window.location.href = '/dashboard';
            } else {
              window.location.href = '/pending-approval';
            }
          } else {
            showToast(data.error || data.message || 'Login failed', 'error');
          }
        } catch (error) {
          showToast('An error occurred. Please try again.', 'error');
        }
      });

      // Clear register field errors
      function clearRegisterErrors() {
        document.getElementById('error_reg_username').textContent = '';
        document.getElementById('error_reg_password').textContent = '';
        const efn = document.getElementById('error_reg_first_name'); if (efn) efn.textContent = '';
        const eln = document.getElementById('error_reg_last_name'); if (eln) eln.textContent = '';
        const c = document.getElementById('error_reg_contact');
        if (c) c.textContent = '';
      }

      function showRegisterError(fieldId, message) {
        const errorDiv = document.getElementById(`error_reg_${fieldId}`);
        if (errorDiv) {
          errorDiv.textContent = message;
        }
      }

      function validateRegisterForm() {
        clearRegisterErrors();
        let isValid = true;

        const username = document.getElementById('reg_username').value.trim();
        const password = document.getElementById('reg_password').value;
        const firstName = document.getElementById('reg_first_name').value.trim();
        const lastName = document.getElementById('reg_last_name').value.trim();
        const contact = (document.getElementById('reg_contact')?.value || '').trim();

        if (!username) {
          showRegisterError('username', 'Username is required');
          isValid = false;
        }

        if (!password) {
          showRegisterError('password', 'Password is required');
          isValid = false;
        } else if (password.length < 8) {
          showRegisterError('password', 'Password must be at least 8 characters');
          isValid = false;
        }

        if (!firstName) {
          showRegisterError('first_name', 'First name is required');
          isValid = false;
        }

        if (!lastName) {
          showRegisterError('last_name', 'Last name is required');
          isValid = false;
        }

        if (contact) {
          const isEmail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(contact);
          const isPHPhone = /^(?:\+63\d{10}|0\d{10})$/.test(contact);
          if (!isEmail && !isPHPhone) {
            const c = document.getElementById('error_reg_contact');
            if (c) c.textContent = 'Enter a valid email or PH phone (+63 or 09)';
            isValid = false;
          }
        }

        return isValid;
      }

      // Handle register step 1
      registerForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        messageDiv.innerHTML = '';

        if (!validateRegisterForm()) {
          return;
        }

        const formData = {
          username: document.getElementById('reg_username').value.trim(),
          password: document.getElementById('reg_password').value,
          first_name: document.getElementById('reg_first_name').value.trim(),
          last_name: document.getElementById('reg_last_name').value.trim(),
          middle_name: document.getElementById('reg_middle_name').value.trim(),
          contact: document.getElementById('reg_contact')?.value.trim(),
          address: document.getElementById('reg_address').value.trim()
        };

        try {
          const isEmail = formData.contact && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(formData.contact);
          const isPHPhone = formData.contact && /^(?:\+63\d{10}|0\d{10})$/.test(formData.contact);

          if (isEmail) {
            const resp = await fetch('/api/auth/register-initiate', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ username: formData.username, password: formData.password, first_name: formData.first_name, last_name: formData.last_name, middle_name: formData.middle_name, contact: formData.contact, address: formData.address })
            });
            const data = await resp.json();
            if (!resp.ok) {
              showToast(data.error || 'Failed to send verification code', 'error');
              return;
            }
            regToken = data.regToken;
            pendingLogin = { username: formData.username, password: formData.password };
            verifyHelp.textContent = `Enter the 6-digit code sent to ${formData.contact}.`;
            registerForm.style.display = 'none';
            registerVerifyForm.style.display = 'block';
            startResendCountdown(60);
          } else if (isPHPhone) {
            const resp = await fetch('/api/auth/register', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ username: formData.username, password: formData.password, first_name: formData.first_name, last_name: formData.last_name, middle_name: formData.middle_name, email: null, phone: formData.contact, address: formData.address })
            });
            const data = await resp.json();
            if (resp.ok) {
              // Auto-login after phone-based registration
              try {
                const loginResp = await fetch('/api/auth/login', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ username: formData.username, password: formData.password })
                });
                const loginData = await loginResp.json();
                if (loginResp.ok) {
                  localStorage.setItem('token', loginData.token);
                  localStorage.setItem('user', JSON.stringify(loginData.user));
                  if (loginData.user.role === 'admin') {
                    window.location.href = '/admin';
                  } else if (loginData.user.approved) {
                    window.location.href = '/dashboard';
                  } else {
                    window.location.href = '/pending-approval';
                  }
                } else {
                  showToast(loginData.error || 'Registered, but auto-login failed. Please login.', 'error');
                  setTimeout(() => { clearForms(); showLogin(); }, 1200);
                }
              } catch (e) {
                showToast('Registered. Please login to continue.', 'info');
                setTimeout(() => { clearForms(); showLogin(); }, 1200);
              }
            } else {
              showToast(data.error || data.message || 'Registration failed', 'error');
            }
          } else {
            showToast('Enter a valid email or PH phone (+63 or 09)', 'error');
          }
        } catch (error) {
          showToast('An error occurred. Please try again.', 'error');
        }
      });

      // Step 2: verify code and complete
      document.getElementById('registerVerifyForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const code = document.getElementById('reg_verification_code').value.trim();
        if (!/^[0-9]{6}$/.test(code)) {
          const el = document.getElementById('error_reg_code');
          if (el) el.textContent = 'Enter the 6-digit code';
          return;
        }
        try {
          const resp = await fetch('/api/auth/register-complete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ regToken, code })
          });
          const data = await resp.json();
          if (resp.ok) {
            // Auto-login after email verification/registration
            if (pendingLogin && pendingLogin.username && pendingLogin.password) {
              try {
                const loginResp = await fetch('/api/auth/login', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ username: pendingLogin.username, password: pendingLogin.password })
                });
                const loginData = await loginResp.json();
                if (loginResp.ok) {
                  localStorage.setItem('token', loginData.token);
                  localStorage.setItem('user', JSON.stringify(loginData.user));
                  if (loginData.user.role === 'admin') {
                    window.location.href = '/admin';
                  } else if (loginData.user.approved) {
                    window.location.href = '/dashboard';
                  } else {
                    window.location.href = '/pending-approval';
                  }
                } else {
                  showToast(loginData.error || 'Registered, but auto-login failed. Please login.', 'error');
                  setTimeout(() => { clearForms(); showLogin(); }, 1200);
                }
              } catch (e) {
                showToast('Registered. Please login to continue.', 'info');
                setTimeout(() => { clearForms(); showLogin(); }, 1200);
              }
            } else {
              showToast('Account created! Switching to loginâ€¦', 'success');
              setTimeout(() => { clearForms(); showLogin(); }, 1500);
            }
          } else {
            showToast(data.error || 'Verification failed', 'error');
          }
        } catch (err) {
          showToast('An error occurred. Please try again.', 'error');
        }
      });

      document.getElementById('backToRegister').addEventListener('click', () => {
        registerVerifyForm.style.display = 'none';
        registerForm.style.display = 'block';
        clearResendCountdown();
      });

      document.getElementById('resendCodeBtn').addEventListener('click', async () => {
        if (resendCodeBtn.disabled) return; // cooldown active
        const payload = {
          username: document.getElementById('reg_username').value.trim(),
          password: document.getElementById('reg_password').value,
          first_name: document.getElementById('reg_first_name').value.trim(),
          last_name: document.getElementById('reg_last_name').value.trim(),
          middle_name: document.getElementById('reg_middle_name').value.trim(),
          contact: document.getElementById('reg_contact').value.trim()
        };
        try {
          const resp = await fetch('/api/auth/register-initiate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const data = await resp.json();
          if (resp.ok) {
            regToken = data.regToken;
            showToast('Verification code resent', 'info');
            startResendCountdown(60);
          } else {
            showToast(data.error || 'Failed to resend code', 'error');
          }
        } catch (e) {
          showToast('An error occurred. Please try again.', 'error');
        }
      });

      // Check URL hash for #login or #register
      const hash = window.location.hash;
      if (hash === '#login') {
        openModal('login');
      } else if (hash === '#register') {
        openModal('register');
      }
    })();
  </script>

  <div class="container">
    <div class="features">
      <div class="feature-card">
        <h3>ðŸ“… Schedule Appointments</h3>
        <p>Book appointments at your convenience without waiting in line.</p>
      </div>
      <div class="feature-card">
        <h3>ðŸ“„ Request Documents</h3>
        <p>Request Barangay Certificates, Clearance, Indigency forms, and more.</p>
      </div>
      <div class="feature-card">
        <h3>ðŸ“Š Track Status</h3>
        <p>Monitor your request status in real-time through your dashboard.</p>
      </div>
      <div class="feature-card">
        <h3>ðŸ”” Get Updates</h3>
        <p>Receive notifications when your documents are ready for pickup.</p>
      </div>
    </div>

    <div class="card" style="margin-top: 48px;">
      <h2>Available Services</h2>
      <ul style="line-height: 2; color: #4a5568; list-style: none; padding-left: 0;">
        <li style="padding: 8px 0; border-bottom: 1px solid #e2e8f0;">âœ“ Barangay Clearance</li>
        <li style="padding: 8px 0; border-bottom: 1px solid #e2e8f0;">âœ“ Certificate of Residency</li>
        <li style="padding: 8px 0; border-bottom: 1px solid #e2e8f0;">âœ“ Certificate of Relationship</li>
        <li style="padding: 8px 0; border-bottom: 1px solid #e2e8f0;">âœ“ Certificate of Indigency</li>
        <li style="padding: 8px 0; border-bottom: 1px solid #e2e8f0;">âœ“ Others (Specify)</li>
        <li style="padding: 8px 0;">âœ“ Other Barangay Services</li>
      </ul>
    </div>
  </div>

  <!-- Floating Site Settings Button -->
  <button id="floatingSiteSettingsBtn" class="floating-settings-btn" aria-label="Site Settings">
    <span class="settings-icon"></span>
  </button>

  <!-- Site Settings Dropdown (for floating button) -->
  <div id="floatingSiteSettingsDropdown" class="floating-settings-dropdown" style="display:none;">
    <div class="settings-item">
      <label class="toggle-label">
        <span>Dark Mode</span>
        <input type="checkbox" id="darkModeToggle" class="toggle-checkbox">
        <span class="toggle-slider"></span>
      </label>
    </div>
    <div class="settings-item">
      <label class="toggle-label">
        <span>24-Hour Time</span>
        <input type="checkbox" id="timeFormatToggle" class="toggle-checkbox">
        <span class="toggle-slider"></span>
      </label>
    </div>
  </div>

  <script src="/js/site-settings.js"></script>
</body>
</html>
